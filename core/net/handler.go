//go:build wasip1

// GENERATED BY 'T'ool 'G'ateway. DO NOT EDIT.
package net

import (
	"log/slog"
	"sync"

	"tgp/core/i18n"
	"tgp/core/wasm"
)

// connectionHandlerMap хранит обработчики соединений для каждого listener.
// Ключ - listenerID, значение - функция обработки соединений.
var (
	connectionHandlerMap = make(map[uint64]func(connID uint64))
	connectionHandlerMu  sync.RWMutex
)

// SetConnectionHandler устанавливает функцию обработки новых соединений для listener.
// Вызывается из пакета http при запуске сервера.
func SetConnectionHandler(listenerID uint64, handler func(connID uint64)) {

	connectionHandlerMu.Lock()
	defer connectionHandlerMu.Unlock()

	connectionHandlerMap[listenerID] = handler
}

// RemoveConnectionHandler удаляет обработчик соединений для listener.
func RemoveConnectionHandler(listenerID uint64) {

	connectionHandlerMu.Lock()
	defer connectionHandlerMu.Unlock()

	delete(connectionHandlerMap, listenerID)
}

// handleNewConnection обрабатывает новое соединение.
// Вызывается из пакета wasm при получении callback on_new_connection.
// Теперь callback передаёт listenerID и connID (16 байт: 8 для listenerID + 8 для connID).
func handleNewConnection(listenerID, connID uint64) {

	connectionHandlerMu.RLock()
	// Получаем handler для конкретного listenerID
	handler, ok := connectionHandlerMap[listenerID]
	connectionHandlerMu.RUnlock()

	if !ok || handler == nil {
		slog.Error(i18n.Msg("handleNewConnection: no connection handler found for listener"), slog.Uint64("listenerID", listenerID), slog.Uint64("connID", connID))
		return
	}

	// ВАЖНО: не используем горутину в WASM, так как выполнение однопоточное
	// Обработка соединения выполняется синхронно
	handler(connID)
}

func init() {

	// Устанавливаем функцию обработки новых соединений в пакете wasm
	wasm.SetHandleNewConnection(handleNewConnection)
}
