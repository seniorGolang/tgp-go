//go:build wasip1

// GENERATED BY 'T'ool 'G'ateway. DO NOT EDIT.

package wasm

import (
	"encoding/binary"
	"fmt"
	"log/slog"

	"github.com/goccy/go-json"

	"tgp/core/i18n"
)

// onNewConnectionHandler обрабатывает новое соединение.
// Читает listenerID и connID из памяти (16 байт: 8 для listenerID + 8 для connID).
// Память освобождается автоматически CallChannel после вызова функции.
func onNewConnectionHandler(ptr uint32, size uint32) (result uint64) {

	// Проверяем размер данных (16 байт: 8 для listenerID + 8 для connID)
	if size != 16 {
		slog.Error(i18n.Msg("onNewConnectionHandler: invalid size"), slog.Int("expected", 16), slog.Int("got", int(size)))
		errorBytes, _ := json.Marshal(map[string]string{
			"error": fmt.Sprintf("invalid data size: expected 16 (listenerID + connID), got %d", size),
		})
		return createErrorResultFromBytes(errorBytes)
	}

	// Читаем данные из памяти
	dataBytes := PtrToByte(ptr, size)
	// Память освобождается CallChannel после вызова функции, не освобождаем здесь

	// Извлекаем listenerID (первые 8 байт) и connID (последние 8 байт)
	listenerID := binary.LittleEndian.Uint64(dataBytes[0:8])
	connID := binary.LittleEndian.Uint64(dataBytes[8:16])

	// Вызываем обработку соединения напрямую
	// handleConnection находится в пакете net для избежания циклического импорта
	// ВАЖНО: вызываем напрямую, так как CallChannel уже обрабатывает вызовы последовательно
	handleNewConnection(listenerID, connID)

	return 0
}

// handleNewConnection обрабатывает новое соединение.
// Вызывает функцию из пакета net для избежания циклического импорта.
func handleNewConnection(listenerID, connID uint64) {

	if netHandleNewConnection == nil {
		slog.Error(i18n.Msg("handleNewConnection: netHandleNewConnection is nil"), slog.Uint64("listenerID", listenerID), slog.Uint64("connID", connID))
		return
	}

	netHandleNewConnection(listenerID, connID)
}

// netHandleNewConnection - указатель на функцию из пакета net.
// Устанавливается через SetHandleNewConnection в init функции пакета net.
var netHandleNewConnection func(listenerID, connID uint64)

// SetHandleNewConnection устанавливает функцию обработки новых соединений из пакета net.
func SetHandleNewConnection(fn func(listenerID, connID uint64)) {

	netHandleNewConnection = fn
}

// OnNewConnectionExported обертка для экспорта функции on_new_connection через WASM.
//
//go:wasmexport on_new_connection
func OnNewConnectionExported(ptr uint32, size uint32) (result uint64) {

	return onNewConnectionHandler(ptr, size)
}
