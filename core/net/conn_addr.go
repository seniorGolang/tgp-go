//go:build wasip1

// GENERATED BY 'T'ool 'G'ateway. DO NOT EDIT.
package net

import (
	"encoding/binary"
	"net"

	"tgp/core/wasm"
)

// RemoteAddr возвращает удалённый адрес соединения.
func (c *Conn) RemoteAddr() (result net.Addr) {

	// Выделяем память для адреса (256 байт должно быть достаточно)
	addrPtr := wasm.Malloc(256)
	if addrPtr == 0 {
		return nil
	}
	defer wasm.Free(addrPtr)

	// Выделяем память для размера (4 байта для uint32)
	// addrLenPtr используется как входной (размер буфера) и выходной (реальная длина)
	addrLenPtr := wasm.Malloc(4)
	if addrLenPtr == 0 {
		return nil
	}
	defer wasm.Free(addrLenPtr)

	// Записываем размер буфера (256) в addrLenPtr (входной параметр)
	bufferSizeBytes := make([]byte, 4)
	binary.LittleEndian.PutUint32(bufferSizeBytes, 256)
	wasm.ByteToPtr(bufferSizeBytes, addrLenPtr)

	// Вызываем host функцию
	ret := conn_remote_addr(c.id, addrPtr, addrLenPtr)

	// Обрабатываем ошибку
	if err := wasm.HandleHostError(ret); err != nil {
		return nil
	}

	// Читаем реальную длину адреса из addrLenPtr (выходной параметр)
	addrLenBytes := wasm.PtrToByte(addrLenPtr, 4)
	if len(addrLenBytes) < 4 {
		return nil
	}
	addrLen := binary.LittleEndian.Uint32(addrLenBytes)

	if addrLen == 0 {
		return nil
	}

	// Читаем адрес из памяти
	addrBytes := wasm.PtrToByte(addrPtr, addrLen)
	if len(addrBytes) == 0 {
		return nil
	}

	address := string(addrBytes)
	return &addr{address: address}
}

// LocalAddr возвращает локальный адрес соединения.
func (c *Conn) LocalAddr() (result net.Addr) {

	// Выделяем память для адреса (256 байт должно быть достаточно)
	addrPtr := wasm.Malloc(256)
	if addrPtr == 0 {
		return nil
	}
	defer wasm.Free(addrPtr)

	// Выделяем память для размера (4 байта для uint32)
	// addrLenPtr используется как входной (размер буфера) и выходной (реальная длина)
	addrLenPtr := wasm.Malloc(4)
	if addrLenPtr == 0 {
		return nil
	}
	defer wasm.Free(addrLenPtr)

	// Записываем размер буфера (256) в addrLenPtr (входной параметр)
	bufferSizeBytes := make([]byte, 4)
	binary.LittleEndian.PutUint32(bufferSizeBytes, 256)
	wasm.ByteToPtr(bufferSizeBytes, addrLenPtr)

	// Вызываем host функцию
	ret := conn_local_addr(c.id, addrPtr, addrLenPtr)

	// Обрабатываем ошибку
	if err := wasm.HandleHostError(ret); err != nil {
		return nil
	}

	// Читаем реальную длину адреса из addrLenPtr (выходной параметр)
	addrLenBytes := wasm.PtrToByte(addrLenPtr, 4)
	if len(addrLenBytes) < 4 {
		return nil
	}
	addrLen := binary.LittleEndian.Uint32(addrLenBytes)

	if addrLen == 0 {
		return nil
	}

	// Читаем адрес из памяти
	addrBytes := wasm.PtrToByte(addrPtr, addrLen)
	if len(addrBytes) == 0 {
		return nil
	}

	address := string(addrBytes)
	return &addr{address: address}
}
