// GENERATED BY 'T'ool 'G'ateway. DO NOT EDIT.
package data

import (
	"errors"
	"fmt"

	"github.com/goccy/go-json"

	"tgp/core/i18n"
)

var (
	// ErrNotFound возвращается, когда ключ не найден в хранилище.
	ErrNotFound = errors.New(i18n.Msg("key not found"))
)

// Storage определяет интерфейс хранилища для запросов и ответов плагинов.
// Request и Response должны быть одного типа, реализующего интерфейс Storage.
// Это обеспечивает полную совместимость входящих параметров и исходящих результатов.
type Storage interface {
	// Set сохраняет значение по ключу.
	Set(name string, value any) (err error)

	// Has проверяет наличие ключа.
	Has(name string) (has bool)

	// GetRaw возвращает значение как json.RawMessage.
	GetRaw(name string) (value json.RawMessage, ok bool)
}

// MapStorage - реализация Storage на основе map[string]json.RawMessage.
// Используется для всех плагинов как Request и Response.
type MapStorage map[string]json.RawMessage

// NewStorage создает новый экземпляр Storage.
func NewStorage() Storage {

	s := make(MapStorage)
	return &s
}

// GetRaw возвращает значение как json.RawMessage.
func (s MapStorage) GetRaw(name string) (value json.RawMessage, ok bool) {

	if s == nil {
		return nil, false
	}
	value, ok = s[name]
	return
}

// Set сохраняет значение по ключу.
func (s MapStorage) Set(name string, value any) (err error) {

	if s == nil {
		return errors.New(i18n.Msg("storage is nil"))
	}
	data, err := json.Marshal(value)
	if err != nil {
		return fmt.Errorf(i18n.Msg("failed to marshal value for key %q")+": %w", name, err)
	}
	s[name] = json.RawMessage(data)
	return
}

// Has проверяет наличие ключа.
func (s MapStorage) Has(name string) (has bool) {

	if s == nil {
		return false
	}
	_, has = s[name]
	return
}

// Get извлекает и десериализует значение в указанный тип.
func Get[T any](store Storage, key string) (value T, err error) {

	if store == nil {
		return value, ErrNotFound
	}
	raw, ok := store.GetRaw(key)
	if !ok {
		return value, fmt.Errorf(i18n.Msg("key %q")+": %w", key, ErrNotFound)
	}
	if err = json.Unmarshal(raw, &value); err != nil {
		return value, fmt.Errorf(i18n.Msg("failed to unmarshal value for key %q")+": %w", key, err)
	}
	return
}
