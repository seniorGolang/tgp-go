//go:build wasip1

// GENERATED BY 'T'ool 'G'ateway. DO NOT EDIT.
package http

import (
	"net/http"
	"sync"

	"tgp/core/wasm"
)

var (
	handlerMap   = make(map[uint64]http.Handler)
	handlerIDGen uint64
	handlerMu    sync.Mutex
)

// ListenAndServe запускает HTTP сервер на указанном адресе.
// Неблокирующая функция - возвращает управление сразу после запуска сервера.
// Возвращает serverID для последующей остановки сервера через StopServerByID.
func ListenAndServe(addr string, handler http.Handler) (serverID uint64, err error) {

	// Регистрируем обработчик и получаем handler_id
	handlerID := registerHandler(handler)

	// Преобразуем адрес в указатель
	addrPtr, addrLen := wasm.StringToPtr(addr)
	defer wasm.Free(addrPtr)

	// Вызываем хост-функцию для запуска сервера
	ret := hostListenAndServe(addrPtr, addrLen, handlerID)

	// Проверяем ошибку
	if err = wasm.HandleHostError(ret); err != nil {
		return 0, err
	}

	// ret содержит serverID в младших 32 битах
	serverID = uint64(uint32(ret))

	return serverID, nil
}

// registerHandler регистрирует обработчик и возвращает его ID.
func registerHandler(handler http.Handler) (handlerID uint64) {

	handlerMu.Lock()
	defer handlerMu.Unlock()

	handlerIDGen++
	handlerMap[handlerIDGen] = handler

	return handlerIDGen
}

// getHandler получает обработчик по ID.
func getHandler(handlerID uint64) (handler http.Handler, ok bool) {

	handlerMu.Lock()
	defer handlerMu.Unlock()

	handler, ok = handlerMap[handlerID]
	return
}
