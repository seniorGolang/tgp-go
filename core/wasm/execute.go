//go:build wasip1

// GENERATED BY 'T'ool 'G'ateway. DO NOT EDIT.

package wasm

import (
	"fmt"

	"github.com/goccy/go-json"

	"tgp/core/data"
	"tgp/core/i18n"
	"tgp/core/plugin"
)

var pluginInstance plugin.Plugin

// SetPluginInstance устанавливает экземпляр плагина.
func SetPluginInstance(p plugin.Plugin) {

	pluginInstance = p
}

// executeHandler обрабатывает запрос на выполнение плагина.
func executeHandler(req executeRequest) (resp executeResponse, err error) {

	// Десериализуем Request в core.MapStorage
	var requestStorage *data.MapStorage
	if len(req.Request) > 0 {
		var ms data.MapStorage
		if err := json.Unmarshal(req.Request, &ms); err != nil {
			return executeResponse{}, err
		}
		requestStorage = &ms
	} else {
		requestStorage = &data.MapStorage{}
	}

	// Вызываем метод Execute плагина
	if pluginInstance == nil {
		return executeResponse{}, fmt.Errorf(i18n.Msg("plugin instance not set"))
	}

	response, err := pluginInstance.Execute(req.RootDir, requestStorage, req.Path...)
	if err != nil {
		resp.Error = err.Error()
		return resp, nil
	}

	if response != nil {
		if ms, ok := response.(*data.MapStorage); ok {
			resp.Response = *ms
		}
	}

	return
}

// ExecuteExported обертка для экспорта функции execute через WASM.
//
//go:wasmexport execute
func ExecuteExported(ptr uint32, size uint32) (result uint64) {

	return exportWrapper(executeHandler)(ptr, size)
}
